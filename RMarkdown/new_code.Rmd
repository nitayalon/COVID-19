---
title: "Testing"
author: "Nitay Alon"
date: "May 5, 2020"
output: html_document
---

```{r}
#Decreasing fit to the ratio of deadincrease to

#deadincrease+recoveredincrease

#input country data QQQ
real_data <- full_data_for_export %>% 
  mutate(VW = val.confirmed_deaths + val) %>% 
  select(X = val.confirmed_cases, V = val.confirmed_deaths, W = val)

nq=nrow(real_data)

#Making sure data is monotone
real_data_matrix <- as.matrix(real_data)
QQ2 = matrix(0,ncol = ncol(real_data_matrix), nrow = nrow(real_data_matrix))
QQ2[1,]=real_data_matrix[1,]

take_max <- function(new_data, old_data)
{
  n <- length(old_data)
  results <- c()
  for(i in 1:n)
  {
    results[i] <- max(c(new_data[i], old_data[i-1]))  
  }
  return(results)
}

QQ3 <- sapply(1:3,function(i){
  take_max(QQ2[,i],real_data_matrix[,i])
})

#Time scale
QQ1=diff(QQ3)

T0=(1:nq-1) #MSQ=10^10
MSQ = 22
# Fitting a sigmoidal function 1/(1+exp(bb*(T-t0))) to the proportion of dead. Two parameters bb and t0
sumsq <- matrix(0, 100, 100)
bb <- 1.5
t0 <- 2.5
for(i in 1:100){
  for(j in 1:100){
        t0=-100+2*i
        bb=j/1000
        sumsq[i,j]=sum(((QQ1[,2]+QQ1[,3])/(1+exp(bb*(T0-t0)))-QQ1[,2])^2/(100+QQ1[,2]+QQ1[,3]))
        if (sumsq[i,j]<MSQ){
          MSQ=sumsq[i,j]  
          i0=i
          j0=j
          t1=t0
          bb1=bb
        }
  }
}
  



%Displaying the results with the fitted parameters bb1 and t1

disp([i0 j0 t1])

disp(bb1)

clear figure(1)

QQ3=QQ2

for i=2:nq

    QQ3(i,2)=QQ3(i-1,2)+(QQ1(i-1,2)+QQ1(i-1,3))/(1+exp(bb1*(i-1-t1)))

    QQ3(i,3)=QQ3(i-1,3)+(QQ1(i-1,2)+QQ1(i-1,3))*(1-1/(1+exp(bb1*(i-1-t1))))

end
```

